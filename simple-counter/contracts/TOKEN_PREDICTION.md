# TokenPrediction - Документация смарт-контракта

## Общее описание

TokenPrediction - это смарт-контракт для предсказания движения цен токенов на блокчейне TON. Пользователи могут делать ставки на повышение (BULL) или понижение (BEAR) цены в течение фиксированных раундов.

## Основные характеристики

- Раунды фиксированной длительности (300 секунд)
- Автоматическое получение цен через DeDust
- Минимальная ставка: 0.1 TON
- Комиссия платформы: 3%
- Пакетная обработка ставок

## Структуры данных

### Round (Раунд)
- epoch: номер раунда
- status: статус (0=не начат, 1=активен, 2=заблокирован, 3=завершен)
- startPrice: начальная цена
- lockPrice: цена при блокировке
- closePrice: финальная цена
- lockTimestamp: время блокировки
- closeTimestamp: время закрытия
- totalAmount: общая сумма ставок
- bullAmount: сумма ставок на повышение
- bearAmount: сумма ставок на понижение

### UserBet (Ставка пользователя)
- epoch: номер раунда
- amount: размер ставки
- isBull: тип ставки (true=BULL, false=BEAR)
- claimed: получен ли выигрыш

### UserRewards (Награды пользователя)
- pendingRewards: невыплаченные награды
- claimedRewards: полученные награды
- lastClaimEpoch: последний раунд с выплатой

## Основные функции

### Для пользователей

1. Размещение ставок:
   - bet_bull: ставка на повышение
   - bet_bear: ставка на понижение

2. Получение выигрышей:
   - claim_all_rewards: вывод всех накопленных наград

### Для администратора

1. Управление раундами:
   - startRound(): запуск нового раунда
   - lockRound(): блокировка приема ставок
   - endRound(): завершение раунда
   - endRoundBatch(): пакетная обработка ставок

2. Управление системой:
   - withdraw_treasury: вывод накопленной комиссии
   - updateDeDustPair: обновление адреса оракула цен
   - updatePriceValidityPeriod: настройка периода валидности цен

## Процесс работы

1. Администратор запускает раунд (startRound)
2. Пользователи делают ставки (bet_bull/bet_bear)
3. Администратор блокирует прием ставок (lockRound)
4. Раунд автоматически завершается через 300 секунд
5. Администратор завершает раунд (endRound)
6. Ставки обрабатываются батчами (endRoundBatch)
7. Пользователи могут забрать выигрыши (claim_all_rewards)

## Формулы расчета

1. Призовой фонд:
   prize_pool = total_amount - (total_amount * treasury_fee / 100)

2. Индивидуальный выигрыш:
   reward = (bet_amount * prize_pool) / winning_pool_amount

## Безопасность

- Все критические функции доступны только владельцу
- Проверки временных меток для операций
- Валидация входных данных
- Защита от повторного получения выигрыша
- Пакетная обработка для оптимизации газа

## Технические требования

- Минимальная сумма ставки: 0.1 TON
- Длительность раунда: 300 секунд
- Период валидности цены: 60 секунд
- Размер батча для обработки: рекомендуется 10-20 ставок

## Рекомендации по использованию

1. Для пользователей:
   - Проверяйте статус раунда перед ставкой
   - Дождитесь обработки всех ставок перед claim_all_rewards
   - Учитывайте комиссию при расчете потенциального выигрыша

2. Для администратора:
   - Регулярно мониторьте статусы раундов
   - Обрабатывайте ставки небольшими батчами
   - Следите за балансом комиссии
   - Проверяйте актуальность цен оракула

## Обработка ошибок

Основные сообщения об ошибках:
- "Only admin": доступ только для администратора
- "Round not live": раунд не активен
- "Bet amount too small": ставка меньше минимальной
- "Round locked": прием ставок заблокирован
- "No pending rewards": нет доступных для вывода наград

## Контакты и поддержка

При возникновении вопросов или проблем обращайтесь:
- Технические вопросы: [support@example.com]
- Баг-репорты: [GitHub Issues]